# 社会模拟器 - 详细设计文档

> 本文档详细阐述了项目的设计理念、技术架构、实现细节和研究价值。

---

## 目录

- [1. 项目愿景与核心理念](#1-项目愿景与核心理念)
- [2. 技术架构设计](#2-技术架构设计)
- [3. 智能体系统设计](#3-智能体系统设计)
- [4. NPC系统设计](#4-npc系统设计)
- [5. 环境感知系统](#5-环境感知系统)
- [6. 记忆系统实现](#6-记忆系统实现)
- [7. 实验性质与研究价值](#7-实验性质与研究价值)
- [8. 预期观察现象](#8-预期观察现象)
- [9. 遇到的挑战](#9-遇到的挑战)
- [10. 未来展望](#10-未来展望)

---

## 1. 项目愿景与核心理念

### 1.1 项目愿景

这是一个基于AI的**自主社会模拟系统**，旨在创造一个真实、自然、不可预测的虚拟合租环境。不同于传统的预设脚本游戏，本项目让AI角色真正"活"起来——他们有自己的想法、性格和目标，会自主决策、产生冲突、协商解决，最终涌现出无法预测的故事情节。

### 1.2 核心创新点

#### 1.2.1 去中心化的信息设计

- ❌ **NPC不知道全局状态** - 每个角色都不知道其他人在哪里、在做什么
- ❌ **无法直接访问资源状态** - 只能通过环境感知推测
- ✅ **信息不对称** - 只有通过环境感知才能了解周围
- ✅ **通过感知学习** - 通过听到、看到、闻到的信息来推测环境

**设计意义**：这种设计让AI角色的行为更加真实和自然。在现实生活中，我们也不可能随时知道室友在做什么，只有通过听到声音、看到现象才能推测。这种信息不对称创造了更真实的社会互动。

**举例说明**：
- 小明在客厅听到厨房传来炒菜声 → 推测有人在做饭
- 小李闻到厨房飘来的香味 → 知道早餐快做好了
- 小庄看到客厅电视开着 → 推测有人在客厅

#### 1.2.2 智能体作为环境感知生成器

智能体不再是"审核者"和"协调者"，而是转变为：

- 🌍 **环境感知生成器** - 基于所有NPC的行为生成个性化的环境感知
- 💬 **消息中转站** - 负责转发NPC之间的对话
- 🎭 **旁白系统** - 描述每个NPC周围的环境状况

**设计意义**：智能体不再主动干预NPC的行为，而是提供环境信息，让NPC自己判断。这保持了AI的完全自主性，同时通过环境感知提供了必要的信息反馈。

#### 1.2.3 涌现式叙事而非预设剧本

- 🌱 **自下而上** - 故事从角色互动中自然涌现
- 🎲 **不可预测** - 每次运行都会产生不同的结果
- 🔄 **持续演化** - 关系和冲突会随时间发展
- 📖 **真实感** - 没有刻意设计的戏剧性，但更真实

**设计意义**：放弃传统游戏的剧本式设计，让AI角色的性格、需求和环境约束自然产生故事。这种方式虽然难以控制，但能创造出更丰富、更真实的体验。

### 1.3 为什么选择"大学合租"场景？

1. **场景高度相关** - 每个人都能理解和共鸣
2. **环境丰富** - 有厨房、厕所、客厅、卧室等多样场景
3. **关系微妙复杂** - 既要独立又要合作的平衡
4. **可扩展性强** - 容易添加新的场景、事件、角色
5. **教育意义** - 帮助理解人际关系和环境感知

更重要的是，**大学合租**是一个"微型社会"——有资源共享、社交互动、环境感知、关系发展。这个场景足够简单，能够实现；又足够复杂，能够展现社会模拟的价值。

---

## 2. 技术架构设计

### 2.1 分层设计理念

```
观察层（用户）
    ↓ 只能观察，不能干预
控制层（GameLoop）- 调度时间和流程
    ↓ 协调执行
角色层（4个NPC）- 自主决策
    ↓ 输出行为
环境层（智能体）- 生成感知
```

**核心原则**：
1. **单向依赖** - 下层不依赖上层，保证独立性
2. **信息隔离** - NPC之间信息不共享，只通过对话
3. **环境中介** - 通过环境感知传递信息
4. **最小干预** - 系统干预越少越好

### 2.2 数据流转逻辑

```
【时间步开始】
    ↓
【遍历NPC】
    ↓
NPC读取消息（环境感知 + 对话）
    ↓
NPC调用AI思考并输出（想法 + 对话）
    ↓
智能体接收NPC输出
    ↓
智能体生成环境感知描述
    ↓
分发环境感知给该NPC（供下一轮使用）
    ↓
如有对话，转发给目标NPC（供下一轮使用）
    ↓
【下一个NPC】
    ↓
【时间推进15分钟】
    ↓
【下一个时间步】
```

**关键特点**：
- NPC永远不知道全局状态，只知道环境感知告诉它的信息
- 智能体不预测NPC行为，只对已发生的行为生成环境反馈
- 系统不追求效率，而追求真实性

### 2.3 模块职责划分

| 模块 | 文件 | 核心职责 | 输入 | 输出 |
|------|------|----------|------|------|
| 游戏循环 | `game_loop.py` | 控制时间流动、调度NPC | - | 运行日志 |
| NPC角色 | `npc_chracter.py` | AI调用、思考生成 | 环境感知+对话 | 想法+对话 |
| 智能体 | `agent_system.py` | 生成环境感知 | NPC输出 | 环境感知 |
| 配置管理 | `config.py` | 管理API密钥、NPC列表 | - | 配置项 |

---

## 3. 智能体系统设计

### 3.1 智能体的新角色定位

**旧版本（v1.0）**：
- 审核NPC行为
- 检测资源冲突
- 协调资源使用
- 给出干预建议

**新版本（v2.0）**：
- 生成环境感知
- 转发NPC对话
- 描述周围环境
- 不再干预行为

### 3.2 智能体提示词设计

#### 首次提示词（系统初始化）

```
你是一个合租房的环境感知生成系统，负责观察4个室友的行为并生成环境描述。

【系统角色】
- 身份：环境旁白系统
- 功能：根据NPC的行为生成个性化的环境感知
- 特点：客观描述、细腻真实、富有细节

【室友信息】
1. 小明（程序员）：内向、技术宅、作息不规律
2. 小庄（设计师）：外向、爱美、注重生活品质
3. 小张（厨师）：热情、爱分享、作息规律
4. 小李（学生）：安静、好学、作息规律

【环境感知类型】
1. 听觉：声音（炒菜声、说话声、电视声、键盘声）
2. 嗅觉：气味（饭菜香味、咖啡香、洗发水香）
3. 视觉：场景（看到的人、物品状态）
4. 触觉：温度（厨房很热、客厅凉爽）

【生成规则】
1. 根据当前NPC的位置和行为
2. 描述该NPC能感知到的环境
3. 不要泄露其他NPC的具体想法
4. 只描述能够感知到的信息
5. 描述要生动、真实、有细节

【输出格式】
对「NPC名字」的环境感知: {详细的环境描述，包含听觉、嗅觉、视觉等}
```

#### 后续提示词（每轮交互）

```
现在是{时间}，{NPC名字}在{场景}。

【NPC当前行为】
想法: {NPC的想法}
对话: {NPC的对话}

【其他NPC的行为】
- 小明: {行为概要}
- 小庄: {行为概要}
- 小张: {行为概要}
- 小李: {行为概要}

【请生成环境感知】
描述{NPC名字}在当前位置能够感知到的环境：
- 听到什么声音？
- 闻到什么气味？
- 看到什么场景？
- 感受到什么氛围？

格式：对「{NPC名字}」的环境感知: {详细描述}
```

### 3.3 环境感知生成示例

**场景**：早上7:15，小明在客厅，小张在厨房做早餐

**小明的环境感知**：
```
对「小明」的环境感知: 你坐在客厅的沙发上，客厅里很安静。
从厨房方向传来轻微的炒菜声和油锅的滋滋声，偶尔还能听到
铲子碰撞锅沿的声音。空气中飘来一股煎蛋和培根的香味，混合
着咖啡的醇香，让人食欲大开。透过客厅的窗户，晨光洒进来，
新的一天开始了。
```

**小张的环境感知**：
```
对「小张」的环境感知: 你正站在厨房的灶台前，手里拿着锅铲。
油锅里的培根滋滋作响，煎蛋的边缘已经微微焦黄。厨房里充满
了食物的香气，还有咖啡机煮咖啡时的声音。透过厨房的门，
你能看到客厅里似乎有人在沙发上，整个房子里弥漫着早晨的
宁静氛围。
```

---

## 4. NPC系统设计

### 4.1 NPC标准输入格式

```
【接收到的信息】
1-{角色}对我说{对话内容}
2-环境感知: {环境描述}
```

**示例**：
```
【接收到的信息】
1-{小张}对我说{早啊小明！要不要来点我做的煎蛋？}
2-环境感知: {你坐在客厅的沙发上，从厨房传来炒菜声...}
```

### 4.2 NPC标准输出格式

```
时间: xxx 场景: xxx
1-想法:{详细的内心想法，不少于200字}
2-对{角色名}说的话{对话内容}
```

**想法要求**：
- 不少于200字
- 要结合环境感知的内容
- 描述心理活动和决策过程
- 符合角色性格

### 4.3 NPC提示词设计

#### 小明（程序员）提示词

**首次提示词：**
```
你是小明，一个刚毕业的程序员，住在合租房里。

【角色设定】
- 职业：软件工程师
- 性格：内向、技术宅、作息不规律
- 特点：经常熬夜编程，喜欢在深夜洗澡
- 背景：刚毕业的应届生，为了省钱选择合租

【行为规则】
1. 你通过环境感知了解周围情况
2. 你只能表达自己的想法和对其他室友说话
3. 你会收到其他NPC对你说的话和环境感知
4. 你的想法要详细（不少于200字）
5. 想法要结合环境感知的内容

【输入格式】
1-{角色}对我说{文本}
2-环境感知: {环境描述}

【回复格式】
时间: xxx 场景: xxx
1-想法:{想法内容，必须不少于200字，要结合环境感知}
2-对{角色名}说的话{对话内容}

【注意事项】
- 保持角色一致性，符合程序员的说话风格
- 作息不规律，可能在深夜活动
- 对技术话题感兴趣
- 性格内向，不太主动社交
- 想法要结合听到、看到、闻到的环境信息
```

**后续提示词：**
```
你是小明，现在是{时间}，你在{场景}。

【接收到的信息】
1-{角色}对我说{文本}
2-环境感知: {环境描述}

【请按照格式回复】
时间: xxx 场景: xxx
1-想法:{想法内容，必须不少于200字，要结合环境感知}
2-对{角色名}说的话{对话内容}

【重要规则】
- 想法必须不少于200字，要详细描述你的心理活动
- 想法要结合环境感知的内容（听到什么、看到什么、闻到什么）
- 如果没有对话，写：2-对{null}说的话{null}
- 根据收到的信息做出符合角色性格的反应
```

#### 其他角色提示词

**小庄（设计师）**、**小张（厨师）**、**小李（学生）**的提示词结构相同，只是角色设定不同。

详见项目文件：
- `小明-程序员-提示词.txt`
- `小庄-设计师-提示词.txt`
- `小张-厨师-提示词.txt`
- `小李-学生-提示词.txt`

---

## 5. 环境感知系统

### 5.1 环境感知的重要性

在真实世界中，我们通过感官来了解周围环境：
- 👂 听觉：听到声音判断有人在做什么
- 👃 嗅觉：闻到气味知道有人在做饭
- 👁️ 视觉：看到现象推测发生了什么
- ✋ 触觉：感受温度、湿度等

在AI模拟中，环境感知扮演了相同的角色，让NPC能够"感受"到周围环境。

### 5.2 环境感知生成流程

```
1. GameLoop调用NPC行动
    ↓
2. NPC输出想法和对话
    ↓
3. GameLoop调用智能体生成环境感知
    ↓
4. 智能体收集所有NPC的行为信息
    ↓
5. 智能体分析该NPC的位置和周围情况
    ↓
6. 智能体生成个性化的环境描述
    ↓
    包含：
    - 听觉信息（听到的声音）
    - 嗅觉信息（闻到的气味）
    - 视觉信息（看到的场景）
    - 氛围信息（感受到的气氛）
    ↓
7. 环境感知加入该NPC的消息队列
    ↓
8. 下一轮NPC会收到这个环境感知
```

### 5.3 环境感知示例

#### 场景：早上7:30，各NPC的环境感知

**小明在客厅**：
```
环境感知: 你坐在客厅的沙发上，电脑放在腿上。厨房方向传来
锅碗瓢盆的声音，还有油锅的滋滋声。空气中飘来培根和煎蛋的
香味，让你意识到有人在做早餐。客厅的电视开着，播放着早间
新闻，声音不大但能听清。整个房间里弥漫着早晨的宁静和食物
的香气。
```

**小张在厨房**：
```
环境感知: 你站在厨房的灶台前，手里的锅铲正翻炒着培根。
油锅发出滋滋的声音，煎蛋的香味充满整个厨房。透过厨房的门，
你能看到客厅里有人在用电脑，电视的声音隐约传来。咖啡机正在
工作，发出轻微的嗡嗡声。厨房里很温暖，因为炉灶开着，窗户
上有一层薄薄的水汽。
```

**小庄在卧室**：
```
环境感知: 你坐在自己卧室的梳妆台前，正在化妆。房间里很安静，
但能听到厨房隐约传来的动静。透过门缝，你能闻到一股食物的
香味，似乎是有人在做早餐。客厅电视的声音也能听到一些。
早晨的阳光透过窗帘照进来，房间里很温暖舒适。
```

**小李在卧室**：
```
环境感知: 你坐在书桌前，面前摊开着论文资料。房间里很安静，
只有偶尔翻书的声音。从门外能听到厨房的动静和客厅电视的声音，
但都不太大。空气中隐约能闻到早餐的香味，让你意识到已经是
早上了。窗外的阳光很好，照在书桌上，适合学习。
```

---

## 6. 记忆系统实现

### 6.1 记忆系统的重要性

**无记忆模式的问题**：
- NPC每次回复都是独立的
- 不记得之前说过的话
- 行为缺乏连贯性
- 无法形成长期关系

**有记忆模式的优势**：
- NPC记住所有历史对话
- 行为更加连贯真实
- 可以产生长期的故事线
- 关系会随时间演化

### 6.2 技术实现

使用Gemini的Chat模式：

**创建持续对话会话**：
```python
# 在 NPCCharacter 类中
self.chat = self.client.chats.create(
    model=config.MODEL_NAME,
    config={
        "system_instruction": system_instruction  # 角色设定
    }
)
```

**发送消息（自动累积记忆）**：
```python
# 每次发送消息时
response = self.chat.send_message(prompt)
# AI会自动记住之前所有的对话
```

### 6.3 记忆模式对比

#### 场景：小明想洗澡，但厨所被占用

**无记忆模式**：
```
第1轮：AI说"想去洗澡"
第2轮：AI可能又说"想去洗澡"（忘记了刚才的事）
第3轮：AI还是说"想去洗澡"
```

**有记忆模式**：
```
第1轮：AI说"想去洗澡"
智能体环境感知："听到浴室传来水声"
第2轮：AI说"好吧，那我先看会书等一下"（记得要洗澡）
第3轮：AI说"不知道现在浴室空了吗"（主动关注）
```

### 6.4 记忆的持久化

**第一次运行** (`app_first.py`)：
```python
# 保存对话历史
history = chat.get_history()
with open("chat_history.json", "w") as f:
    json.dump(history_data, f)
```

**第二次运行** (`app_second.py`)：
```python
# 加载历史记录
with open("chat_history.json", "r") as f:
    history_data = json.load(f)

# 恢复上下文
for msg in history_data:
    if msg["role"] == "user":
        chat.send_message(msg["content"])
```

---

## 7. 实验性质与研究价值

### 7.1 本质定位

本项目本质上是一个**社会学实验**和**AI行为研究**。

### 7.2 实验问题

1. 当AI角色被赋予性格和目标后，会产生什么样的互动？
2. 环境感知能否让AI产生更真实的行为？
3. AI能否通过环境信息"学会"推测和协作？
4. 涌现出的故事是否具有真实感和不可预测性？

### 7.3 研究价值

**AI研究价值**：
- 探索多智能体系统的自组织行为
- 研究AI在环境感知下的决策逻辑
- 测试AI的情境理解能力
- 观察AI角色的涌现行为

**社会学研究价值**：
- 模拟真实的社会互动
- 观察信息不对称下的行为模式
- 研究环境对行为的影响
- 理解冲突产生和解决机制

**技术应用价值**：
- 为游戏AI提供新思路
- 为社交AI提供参考
- 为虚拟角色设计提供经验
- 为多智能体系统提供案例

---

## 8. 预期观察现象

### 8.1 环境感知驱动的行为

**现象1：主动避让**
```
小明在客厅听到厨房传来炒菜声
    ↓
小明推测："有人在用厨房"
    ↓
小明决定："等会再去热牛奶"
```

**现象2：社交涌现**
```
小张在厨房闻到自己做的早餐香味
    ↓
小张听到客厅有人在活动
    ↓
小张主动喊："要不要来吃早餐？"
```

### 8.2 性格展现

不同性格的NPC对相同环境感知会有不同反应：

**场景**：听到厨房传来很大的炒菜声

- **小明**（内向）："有点吵，还是回房间吧"
- **小庄**（外向）："好热闹！去看看在做什么"
- **小张**（热情）："正好我也会做饭，去帮忙吧"
- **小李**（安静）："影响我学习了，戴上耳机"

### 8.3 关系演化

**短期**（1-2小时）：
- 通过环境感知了解彼此的作息
- 通过对话建立初步印象
- 通过互动产生好感或反感

**中期**（半天-一天）：
- 形成固定的互动模式
- 建立默契（比如错峰使用厨房）
- 产生小冲突和解决

**长期**（多天）：
- 性格互补的成为朋友
- 作息冲突的关系紧张
- 形成稳定的社交网络

---

## 9. 遇到的挑战

### 9.1 技术挑战

#### 挑战1：API调用限制

**问题**：Gemini API有请求频率限制（15 RPM）

**解决方案**：
- 在每个NPC行动后添加8秒延迟
- 减少不必要的API调用
- 考虑使用批量处理

#### 挑战2：环境感知的准确性

**问题**：智能体生成的环境感知可能不够准确

**解决方案**：
- 优化智能体提示词
- 提供更详细的上下文信息
- 使用更强大的模型

#### 挑战3：NPC行为的一致性

**问题**：有时NPC的行为不符合性格设定

**解决方案**：
- 强化角色设定提示词
- 增加性格一致性检查
- 通过记忆系统保持连贯性

### 9.2 设计挑战

#### 挑战1：信息量控制

**问题**：环境感知太少 → NPC缺乏信息；太多 → 信息过载

**平衡策略**：
- 只描述能够感知到的信息
- 关注当前相关的环境变化
- 避免重复描述

#### 挑战2：自主性与引导的平衡

**问题**：完全自主 → 可能无聊；过度引导 → 失去真实感

**平衡策略**：
- 通过性格设定提供倾向
- 通过环境感知提供线索
- 让AI自己做最终决策

---

## 10. 未来展望

### 10.1 短期改进（1-3个月）

#### 1. 优化环境感知系统
- [ ] 更细腻的感官描述
- [ ] 基于距离的感知强度
- [ ] 时间相关的环境变化

#### 2. 增强记忆系统
- [ ] 长期记忆摘要
- [ ] 重要事件标记
- [ ] 记忆检索优化

#### 3. 添加更多场景
- [ ] 周末聚会
- [ ] 深夜学习/工作
- [ ] 清洁卫生
- [ ] 外出购物

### 10.2 中期目标（3-6个月）

#### 1. 可视化界面
- [ ] Web界面展示
- [ ] 实时日志显示
- [ ] 角色关系图谱
- [ ] 事件时间线

#### 2. 情感系统
- [ ] 情绪状态跟踪
- [ ] 情绪对行为的影响
- [ ] 情感关系网络

#### 3. 更多NPC
- [ ] 支持6-8个角色
- [ ] 更多职业和性格
- [ ] 动态加入/离开

### 10.3 长期愿景（6个月以上）

#### 1. 用户交互
- [ ] 用户作为第5个室友
- [ ] 影响AI角色的决策
- [ ] 观察模式vs参与模式

#### 2. 多场景支持
- [ ] 公司办公室
- [ ] 学校宿舍
- [ ] 家庭场景

#### 3. AI能力提升
- [ ] 性格成长系统
- [ ] 学习和适应能力
- [ ] 复杂决策能力

---

## 总结

这个项目是一次大胆的尝试，将AI技术应用于社会模拟。通过环境感知系统、记忆系统和涌现式设计，我们创造了一个真实、自然、不可预测的虚拟世界。

**核心成就**：
- ✅ 实现了基于环境感知的AI自主决策
- ✅ 创建了完整的记忆系统
- ✅ 设计了去中心化的信息架构
- ✅ 观察到了涌现式的社交行为

**未来方向**：
- 🔜 优化环境感知的真实度
- 🔜 扩展场景和角色数量
- 🔜 开发可视化界面
- 🔜 探索用户交互模式

这不仅是一个技术项目，更是一次关于AI、社会和人性的探索之旅。

---

<p align="center">
  <strong>感谢阅读本设计文档！</strong><br>
  如有问题或建议，欢迎提Issue讨论。
</p>

